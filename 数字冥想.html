<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数字冥想计数器 - 正念练习</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f1923;
      /* 深色背景 */
      font-family: "Microsoft YaHei", "SimHei", sans-serif;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #cce5ff;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .ui-container {
      position: relative;
      z-index: 1;
      text-align: center;
      width: 100%;
      padding: 20px;
    }

    .title {
      font-size: 32px;
      margin-bottom: 20px;
      color: #64c8ff;
      text-shadow: 0 0 10px rgba(100, 200, 255, 0.3);
    }

    .stats {
      font-size: 16px;
      line-height: 1.8;
      margin-bottom: 40px;
      color: #d4e6ff;
    }

    .breath-circle-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: 0 auto 30px;
    }

    .instruction {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }

    .cycle-count {
      font-size: 36px;
      color: #e6f2ff;
      margin-bottom: 40px;
    }

    .instructions {
      font-size: 14px;
      line-height: 1.8;
      color: #a8c8e6;
      max-width: 600px;
      margin: 0 auto 20px;
    }

    .mindfulness-tip {
      font-size: 15px;
      color: #ffcc66;
      text-shadow: 0 0 8px rgba(255, 204, 102, 0.3);
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>
  <div class="ui-container">
    <h1 class="title">正念呼吸计数器</h1>

    <div class="stats">
      呼吸循环: <span id="cycle-count">0</span> |
      练习时间: <span id="total-time">00:00</span> |
      当前阶段: <span id="current-phase">吸气</span>
    </div>

    <div class="breath-circle-container">
      <!-- 呼吸圆圈由Canvas绘制 -->
    </div>

    <div class="instruction" id="breath-instruction">吸气</div>
    <div class="cycle-count">循环次数: <span id="cycle-display">0</span></div>

    <div class="instructions">
      跟随圆圈的扩张和收缩进行呼吸<br>
      吸气时圆圈扩大，呼气时圆圈缩小<br>
      R键: 重置计数器<br>
      专注于呼吸，让思绪沉淀
    </div>

    <div class="mindfulness-tip" id="mindfulness-tip">感受空气进入和离开你的身体</div>
  </div>

  <script>
    // 初始化画布
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    // 适配窗口大小
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    const width = canvas.width;
    const height = canvas.height;

    // 颜色配置（和原Pygame一致）
    const COLORS = {
      PRIMARY: [100, 200, 255],
      SECONDARY: [200, 230, 255],
      ACCENT: [255, 200, 100],
      PHASES: [
        { name: "吸气", duration: 4, color: [100, 200, 255] },
        { name: "屏息", duration: 2, color: [150, 150, 255] },
        { name: "呼气", duration: 6, color: [255, 150, 150] },
        { name: "屏息", duration: 2, color: [255, 200, 100] }
      ]
    };

    // 呼吸状态类
    class BreathingState {
      constructor() {
        this.phase = 0; // 0:吸气, 1:屏息, 2:呼气, 3:屏息
        this.progress = 0;
        this.cycleCount = 0;
        this.totalTime = 0;
        this.phases = COLORS.PHASES;
      }

      update(dt) {
        this.totalTime += dt;
        const currentPhase = this.phases[this.phase];
        const phaseDuration = currentPhase.duration;

        this.progress += dt / phaseDuration;

        if (this.progress >= 1) {
          this.progress = 0;
          this.phase = (this.phase + 1) % this.phases.length;
          if (this.phase === 0) {
            this.cycleCount++;
          }
        }
      }

      getCurrentInstruction() {
        return this.phases[this.phase].name;
      }

      getCurrentColor() {
        return this.phases[this.phase].color;
      }

      getBreathCircleRadius() {
        const baseRadius = 80;
        switch (this.phase) {
          case 0: // 吸气：扩大
            return baseRadius + 120 * this.progress;
          case 1: // 屏息：最大
            return baseRadius + 120;
          case 2: // 呼气：缩小
            return baseRadius + 120 * (1 - this.progress);
          case 3: // 屏息：最小
            return baseRadius;
          default:
            return baseRadius;
        }
      }

      reset() {
        this.phase = 0;
        this.progress = 0;
        this.cycleCount = 0;
        this.totalTime = 0;
      }
    }

    // 冥想粒子类
    class MeditationParticle {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.angle = Math.random() * Math.PI * 2;
        this.speed = Math.random() * 1.5 + 0.5; // 0.5-2.0
        this.distance = Math.random() * 150 + 50; // 50-200
        this.size = Math.random() * 2 + 1; // 1-3
        this.color = COLORS.PRIMARY;
        this.alpha = Math.random() * 150 + 50; // 50-200
        this.speedScale = Math.random() * 1 + 0.5; // 0.5-1.5
      }

      update(time, breathRadius) {
        // 围绕中心旋转，受呼吸影响
        this.angle += 0.02 * this.speedScale;
        const baseDistance = breathRadius + 50;
        this.x = width / 2 + Math.cos(this.angle) * (baseDistance + this.distance * 0.3);
        this.y = height / 2 + Math.sin(this.angle) * (baseDistance + this.distance * 0.3);

        // 呼吸式闪烁
        this.alpha = 100 + 100 * Math.sin(time * 2 + this.angle);
      }

      draw() {
        ctx.save();
        ctx.globalAlpha = this.alpha / 255;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fillStyle = `rgb(${this.color[0]}, ${this.color[1]}, ${this.color[2]})`;
        ctx.fill();
        ctx.restore();
      }
    }

    // 初始化核心对象
    const breathing = new BreathingState();
    const particles = Array.from({ length: 100 }, () => new MeditationParticle(width / 2, height / 2));

    // DOM元素
    const cycleCountEl = document.getElementById('cycle-count');
    const totalTimeEl = document.getElementById('total-time');
    const currentPhaseEl = document.getElementById('current-phase');
    const breathInstructionEl = document.getElementById('breath-instruction');
    const cycleDisplayEl = document.getElementById('cycle-display');
    const mindfulnessTipEl = document.getElementById('mindfulness-tip');

    // 正念提示文本
    const mindfulnessTips = [
      "感受空气进入和离开你的身体",
      "注意胸腔的起伏",
      "放松肩膀和面部肌肉",
      "接纳当下的感受，不加评判"
    ];

    // 工具函数
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // 绘制呼吸圆圈和进度弧
    function drawBreathingCircle(radius, color, progress) {
      const centerX = width / 2;
      const centerY = height / 2;

      // 绘制主圆圈
      ctx.save();
      ctx.strokeStyle = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.stroke();
      ctx.restore();

      // 绘制进度弧
      if (progress > 0) {
        const startAngle = -Math.PI / 2;
        const endAngle = startAngle + Math.PI * 2 * progress;
        const arcRadius = radius + 5;

        ctx.save();
        ctx.strokeStyle = `rgb(${COLORS.ACCENT[0]}, ${COLORS.ACCENT[1]}, ${COLORS.ACCENT[2]})`;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(centerX, centerY, arcRadius, startAngle, endAngle);
        ctx.stroke();
        ctx.restore();
      }
    }

    // 键盘事件（R键重置）
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' || e.key === 'R') {
        breathing.reset();
      }
    });

    // 动画循环
    let lastTime = Date.now();
    function animate() {
      const currentTime = Date.now();
      const dt = (currentTime - lastTime) / 1000;
      lastTime = currentTime;

      // 减慢呼吸速度（和原Pygame一致）
      breathing.update(dt / 2);

      // 清屏（半透明清屏，保留粒子拖影）
      ctx.fillStyle = 'rgba(15, 25, 35, 0.1)';
      ctx.fillRect(0, 0, width, height);

      // 更新并绘制粒子
      const breathRadius = breathing.getBreathCircleRadius();
      particles.forEach(particle => {
        particle.update(currentTime / 1000, breathRadius);
        particle.draw();
      });

      // 绘制呼吸圆圈
      const currentColor = breathing.getCurrentColor();
      drawBreathingCircle(breathRadius, currentColor, breathing.progress);

      // 更新UI
      cycleCountEl.textContent = breathing.cycleCount;
      totalTimeEl.textContent = formatTime(breathing.totalTime);
      currentPhaseEl.textContent = breathing.getCurrentInstruction();
      breathInstructionEl.textContent = breathing.getCurrentInstruction();
      breathInstructionEl.style.color = `rgb(${currentColor[0]}, ${currentColor[1]}, ${currentColor[2]})`;
      cycleDisplayEl.textContent = breathing.cycleCount;

      // 切换正念提示（每8秒一次）
      const tipIndex = Math.floor(currentTime / 8000) % mindfulnessTips.length;
      mindfulnessTipEl.textContent = mindfulnessTips[tipIndex];

      requestAnimationFrame(animate);
    }

    // 启动动画
    animate();
  </script>
</body>

</html>